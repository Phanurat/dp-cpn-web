<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>CNP Blockchain - Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/web3@1.10.0/dist/web3.min.js"></script>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <link rel="icon" type="image" href="logo/logo.png">
  <style>
    body {
      font-family: sans-serif;
      padding: 2rem;
      background-color: #f4f4f4;
    }

    h2 {
      margin-bottom: 1rem;
    }

    #status {
      margin-bottom: 1rem;
      font-weight: bold;
    }

    select,
    button {
      padding: 0.5rem;
      border-radius: 8px;
      margin-bottom: 1rem;
    }

    ul {
      padding: 0;
    }

    li {
      list-style: none;
      background: white;
      margin-bottom: 1rem;
      padding: 1rem;
      border-radius: 8px;
      box-shadow: 0 1px 4px rgba(0, 0, 0, 0.1);
    }
  </style>
</head>

<body>
  <h2>ğŸ“„ Data Details </h2>

  <label for="contractSelector">ğŸ”— Select Smart Contract:</label>
  <select id="contractSelector">
  </select>

  <div id="status">â³ Loading...</div>
  <ul id="orderList"></ul>

  <script>
    const contractABI = [
      {
        "inputs": [{ "internalType": "string", "name": "_data", "type": "string" }],
        "name": "setName",
        "outputs": [],
        "stateMutability": "nonpayable",
        "type": "function"
      },
      {
        "inputs": [],
        "name": "getName",
        "outputs": [{ "internalType": "string", "name": "", "type": "string" }],
        "stateMutability": "view",
        "type": "function"
      }
    ];

    let web3;
    let contract;

    async function init() {
      if (window.ethereum) {
        web3 = new Web3(window.ethereum);
        await window.ethereum.request({ method: 'eth_requestAccounts' });
        await loadContractOptions();
      } else {
        alert("âš ï¸ Please install MetaMask.");
      }
    }

    async function loadContractOptions() {
      const selector = document.getElementById("contractSelector");
      selector.innerHTML = "<option>â³ Downloading...</option>";

      try {
        const response = await fetch("/api/contracts");
        const data = await response.json();

        selector.innerHTML = "";

        data.forEach(item => {
          const option = document.createElement("option");
          option.value = item.id_contracts;
          option.textContent = `ID ${item.id} - ${item.id_contracts}`;
          selector.appendChild(option);
        });

        selector.addEventListener("change", onContractChange);
        if (data.length > 0) {
          await onContractChange();
        }

      } catch (err) {
        console.error("âŒ list contract unsuccess:", err);
        document.getElementById("status").textContent = "âŒ load contract from database";
      }
    }

    async function onContractChange() {
      const address = document.getElementById("contractSelector").value;
      contract = new web3.eth.Contract(contractABI, address);
      console.log("ğŸ“¦ Loaded contract:", address);
      document.getElementById("status").textContent = `ğŸ“ List: ${address}`;
      await loadOrders();
    }

    async function loadOrders() {
      const list = document.getElementById("orderList");
      list.innerHTML = "";
      const status = document.getElementById("status");

      try {
        const encoded = await contract.methods.getName().call();
        console.log("ğŸ“¦ Encoded:", encoded);

        const decoded = JSON.parse(atob(encoded));
        console.log("ğŸ”“ Decoded:", decoded);

        decoded.forEach(order => {
          const li = document.createElement("li");
          li.innerHTML = `
            ğŸ†” Order ID: <strong>${order[0]}</strong><br>
            ğŸ“… Date: ${order[1]}<br>
            ğŸ§¾ Type: ${order[2]}<br>
            ğŸ“Œ Status: ${order[3]}<br>
            âš¡ Energy: ${order[4]} kWh<br>
            ğŸ’¸ Avg Price: ${order[5]} THB<br>
            ğŸ’° Total: ${order[6]} THB
          `;
          list.appendChild(li);
        });

        status.textContent = `âœ… Load (${decoded.length} list)`;

      } catch (err) {
        console.error("âŒ Error:", err);
        status.textContent = "âŒ Unable to display data (data may not be available or may be incorrect)";
      }
    }

    init();
  </script>
</body>

</html>